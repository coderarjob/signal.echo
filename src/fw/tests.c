#include <hal.h>
#include <hw/hwspec.h>
#include <stdint.h>
#include <main.h>
#include <utils.h>
#include <hw/hwdetect.h>
#if ARCH == AVR
    #if !defined(UNITTESTS)
        #include <avr/pgmspace.h>
        #define ARCH_IMPL_PROG_MEM PROGMEM
    #else
        #define ARCH_IMPL_PROG_MEM
    #endif
#endif

const uint8_t am_data[] ARCH_IMPL_PROG_MEM = {
    32, 32, 32, 32, 32, 32, 32, 32, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 32,
    32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31,
    31, 31, 31, 31, 31, 32, 32, 32, 32, 32, 32, 32, 33, 32, 32, 32, 32, 32, 32, 32, 31, 31, 31, 31,
    31, 30, 30, 30, 30, 30, 30, 31, 31, 31, 31, 32, 32, 32, 32, 33, 33, 33, 33, 33, 33, 33, 33, 32,
    32, 32, 31, 31, 31, 30, 30, 30, 30, 30, 30, 30, 30, 30, 31, 31, 31, 32, 32, 32, 33, 33, 33, 33,
    34, 33, 33, 33, 33, 33, 32, 32, 31, 31, 30, 30, 30, 29, 29, 29, 29, 29, 30, 30, 30, 31, 31, 32,
    32, 33, 33, 33, 34, 34, 34, 34, 34, 34, 33, 33, 32, 32, 31, 31, 30, 30, 29, 29, 29, 29, 29, 29,
    29, 30, 30, 31, 31, 32, 32, 33, 33, 34, 34, 34, 35, 34, 34, 34, 34, 33, 32, 32, 31, 31, 30, 29,
    29, 29, 28, 28, 28, 28, 29, 29, 30, 30, 31, 32, 33, 33, 34, 34, 35, 35, 35, 35, 35, 34, 34, 33,
    33, 32, 31, 30, 30, 29, 28, 28, 28, 28, 28, 28, 28, 29, 30, 30, 31, 32, 33, 33, 34, 35, 35, 35,
    36, 35, 35, 35, 34, 34, 33, 32, 31, 30, 29, 29, 28, 28, 27, 27, 27, 28, 28, 29, 29, 30, 31, 32,
    33, 34, 34, 35, 36, 36, 36, 36, 36, 35, 35, 34, 33, 32, 31, 30, 29, 28, 28, 27, 27, 27, 27, 27,
    28, 28, 29, 30, 31, 32, 33, 34, 35, 36, 36, 36, 37, 36, 36, 36, 35, 34, 33, 32, 31, 30, 29, 28,
    27, 27, 26, 26, 26, 27, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 36, 37, 37, 37, 37, 36, 35, 34,
    33, 32, 31, 30, 29, 28, 27, 26, 26, 26, 26, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 37,
    37, 37, 37, 36, 36, 35, 33, 32, 31, 30, 28, 27, 26, 26, 25, 25, 25, 26, 26, 27, 28, 30, 31, 32,
    33, 35, 36, 37, 37, 38, 38, 38, 37, 37, 36, 35, 34, 32, 31, 29, 28, 27, 26, 25, 25, 25, 25, 25,
    26, 27, 28, 29, 31, 32, 34, 35, 36, 37, 38, 38, 38, 38, 38, 37, 36, 35, 34, 32, 31, 29, 28, 27,
    26, 25, 24, 24, 24, 25, 26, 27, 28, 29, 31, 32, 34, 35, 36, 38, 38, 39, 39, 39, 38, 38, 37, 35,
    34, 32, 31, 29, 28, 26, 25, 24, 24, 24, 24, 24, 25, 26, 28, 29, 31, 32, 34, 35, 37, 38, 39, 39,
    39, 39, 39, 38, 37, 36, 34, 32, 31, 29, 27, 26, 25, 24, 23, 23, 23, 24, 25, 26, 27, 29, 31, 32,
    34, 36, 37, 38, 39, 40, 40, 40, 39, 38, 37, 36, 34, 32, 31, 29, 27, 26, 25, 24, 23, 23, 23, 24,
    24, 26, 27, 29, 31, 32, 34, 36, 37, 39, 40, 40, 40, 40, 40, 39, 38, 36, 34, 32, 31, 29, 27, 25,
    24, 23, 23, 22, 23, 23, 24, 25, 27, 29, 31, 32, 34, 36, 38, 39, 40, 41, 41, 41, 40, 39, 38, 36,
    34, 32, 31, 29, 27, 25, 24, 23, 22, 22, 22, 23, 24, 25, 27, 28, 30, 33, 35, 36, 38, 39, 41, 41,
    41, 41, 41, 40, 38, 36, 35, 33, 30, 28, 26, 25, 23, 22, 22, 21, 22, 22, 23, 25, 26, 28, 30, 33,
    35, 37, 38, 40, 41, 42, 42, 42, 41, 40, 38, 37, 35, 33, 30, 28, 26, 24, 23, 22, 21, 21, 21, 22,
    23, 24, 26, 28, 30, 33, 35, 37, 39, 40, 41, 42, 42, 42, 41, 40, 39, 37, 35, 33, 30, 28, 26, 24,
    23, 21, 21, 20, 21, 21, 23, 24, 26, 28, 30, 33, 35, 37, 39, 41, 42, 43, 43, 43, 42, 41, 39, 37,
    35, 33, 30, 28, 26, 24, 22, 21, 20, 20, 20, 21, 22, 24, 26, 28, 30, 33, 35, 37, 39, 41, 42, 43,
    43, 43, 42, 41, 39, 37, 35, 33, 30, 28, 26, 24, 22, 21, 20, 19, 20, 20, 22, 23, 25, 28, 30, 33,
    35, 38, 40, 41, 43, 43, 44, 43, 43, 41, 40, 38, 35, 33, 30, 28, 25, 23, 21, 20, 19, 19, 19, 20,
    21, 23, 25, 28, 30, 33, 35, 38, 40, 42, 43, 44, 44, 44, 43, 42, 40, 38, 35, 33, 30, 28, 25, 23,
    21, 20, 19, 19, 19, 20, 21, 23, 25, 27, 30, 33, 36, 38, 40, 42, 44, 44, 45, 44, 44, 42, 40, 38,
    36, 33, 30, 27, 25, 23, 21, 19, 18, 18, 18, 19, 21, 22, 25, 27, 30, 33, 36, 38, 41, 42, 44, 45,
    45, 45, 44, 43, 41, 38, 36, 33, 30, 27, 25, 22, 20, 19, 18, 18, 18, 19, 20, 22, 25, 27, 30, 33,
    36, 39, 41, 43, 44, 45, 46, 45, 44, 43, 41, 39, 36, 33, 30, 27, 24, 22, 20, 18, 18, 17, 17, 18,
    20, 22, 24, 27, 30, 33, 36, 39, 41, 43, 45, 46, 46, 46, 45, 43, 41, 39, 36, 33, 30, 27, 24, 22,
    20, 18, 17, 17, 17, 18, 20, 22, 24, 27, 30, 33, 36, 39, 41, 44, 45, 46, 46, 46, 45, 44, 42, 39,
    36, 33, 30, 27, 24, 21, 19, 18, 17, 16, 17, 18, 19, 21, 24, 27, 30, 33, 36, 39, 42, 44, 46, 47,
    47, 47, 46, 44, 42, 39, 36, 33, 30, 27, 24, 21, 19, 17, 16, 16, 16, 17, 19, 21, 24, 27, 30, 33,
    36, 39, 42, 44, 46, 47, 47, 47, 46, 44, 42, 39, 36, 33, 30, 27, 24, 21, 19, 17, 16, 15, 16, 17,
    18, 21, 23, 27, 30, 33, 37, 40, 42, 45, 46, 47, 48, 47, 46, 45, 42, 40, 37, 33, 30, 26, 23, 20,
    18, 16, 15, 15, 15, 16, 18, 20, 23, 26, 30, 33, 37, 40, 43, 45, 47, 48, 48, 48, 47, 45, 43, 40,
    37, 33, 30, 26, 23, 20, 18, 16, 15, 15, 15, 16, 18, 20, 23, 26, 30, 33, 37, 40, 43, 45, 47, 48,
    49, 48, 47, 45, 43, 40, 37, 33, 30, 26, 23, 20, 17, 16, 15, 14, 15, 16, 17, 20, 23, 26, 30, 33,
    37, 40, 43, 46, 48, 49, 49, 49, 48, 46, 43, 40, 37, 33, 30, 26, 23, 20, 17, 15, 14, 14, 14, 15,
    17, 20, 23, 26, 30, 33, 37, 40, 43, 46, 48, 49, 49, 49, 48, 46, 44, 41, 37, 33, 30, 26, 22, 19,
    17, 15, 14, 13, 14, 15, 17, 19, 22, 26, 30, 33, 37, 41, 44, 46, 48, 49, 50, 50, 48, 46, 44, 41,
    37, 33, 30, 26, 22, 19, 16, 15, 13, 13, 13, 14, 16, 19, 22, 26, 30, 33, 37, 41, 44, 47, 49, 50,
    50, 50, 49, 47, 44, 41, 37, 33, 30, 26, 22, 19, 16, 14, 13, 12, 13, 14, 16, 19, 22, 26, 30, 33,
    37, 41, 44, 47, 49, 50, 51, 50, 49, 47, 44, 41, 37, 34, 29, 26, 22, 19, 16, 14, 13, 12, 12, 14,
    16, 18, 22, 25, 29, 34, 38, 41, 45, 47, 49, 51, 51, 51, 49, 47, 45, 41, 38, 34, 29, 25, 22, 18,
    16, 13, 12, 12, 12, 13, 15, 18, 22, 25, 29, 34, 38, 41, 45, 48, 50, 51, 52, 51, 50, 48, 45, 42,
    38, 34, 29, 25, 21, 18, 15, 13, 12, 11, 12, 13, 15, 18, 21, 25, 29, 34, 38, 42, 45, 48, 50, 51,
    52, 51, 50, 48, 45, 42, 38, 34, 29, 25, 21, 18, 15, 13, 11, 11, 11, 13, 15, 18, 21, 25, 29, 34,
    38, 42, 45, 48, 50, 52, 52, 52, 51, 48, 45, 42, 38, 34, 29, 25, 21, 18, 15, 12, 11, 11, 11, 12,
    15, 17, 21, 25, 29, 34, 38, 42, 46, 49, 51, 52, 53, 52, 51, 49, 46, 42, 38, 34, 29, 25, 21, 17,
    14, 12, 11, 10, 11, 12, 14, 17, 21, 25, 29, 34, 38, 42, 46, 49, 51, 53, 53, 53, 51, 49, 46, 42,
    38, 34, 29, 25, 21, 17, 14, 12, 10, 10, 10, 12, 14, 17, 21, 25, 29, 34, 38, 42, 46, 49, 51, 53,
    53, 53, 52, 49, 46, 42, 38, 34, 29, 25, 20, 17, 14, 11, 10, 9,  10, 11, 14, 17, 20, 25, 29, 34,
    38, 43, 46, 49, 52, 53, 54, 53, 52, 50, 46, 43, 38, 34, 29, 25, 20, 17, 13, 11, 10, 9,  10, 11,
    13, 16, 20, 25, 29, 34, 38, 43, 47, 50, 52, 54, 54, 54, 52, 50, 47, 43, 39, 34, 29, 24, 20, 16,
    13, 11, 9,  9,  9,  11, 13, 16, 20, 24, 29, 34, 39, 43, 47, 50, 52, 54, 54, 54, 53, 50, 47, 43,
    39, 34, 29, 24, 20, 16, 13, 10, 9,  8,  9,  10, 13, 16, 20, 24, 29, 34, 39, 43, 47, 50, 53, 54,
    55, 54, 53, 50, 47, 43, 39, 34, 29, 24, 20, 16, 13, 10, 9,  8,  9,  10, 12, 16, 20, 24, 29, 34,
    39, 43, 47, 51, 53, 55, 55, 55, 53, 51, 47, 43, 39, 34, 29, 24, 20, 16, 12, 10, 8,  8,  8,  10,
    12, 16, 20, 24, 29, 34, 39, 43, 48, 51, 53, 55, 56, 55, 53, 51, 48, 44, 39, 34, 29, 24, 19, 15,
    12, 9,  8,  7,  8,  9,  12, 15, 19, 24, 29, 34, 39, 44, 48, 51, 54, 55, 56, 55, 54, 51, 48, 44,
    39, 34, 29, 24, 19, 15, 12, 9,  8,  7,  8,  9,  12, 15, 19, 24, 29, 34, 39, 44, 48, 51, 54, 56,
    56, 56, 54, 51, 48, 44, 39, 34, 29, 24, 19, 15, 11, 9,  7,  7,  7,  9,  11, 15, 19, 24, 29, 34,
    39, 44, 48, 52, 54, 56, 56, 56, 54, 52, 48, 44, 39, 34, 29, 24, 19, 15, 11, 9,  7,  6,  7,  9,
    11, 15, 19, 24, 29, 34, 39, 44, 48, 52, 55, 56, 57, 56, 55, 52, 48, 44, 39, 34, 29, 24, 19, 15,
    11, 8,  7,  6,  7,  8,  11, 14, 19, 24, 29, 34, 39, 44, 49, 52, 55, 57, 57, 57, 55, 52, 49, 44,
    39, 34, 29, 24, 19, 14, 11, 8,  6,  6,  6,  8,  11, 14, 19, 24, 29, 34, 39, 44, 49, 52, 55, 57,
    57, 57, 55, 52, 49, 44, 40, 34, 29, 23, 19, 14, 10, 8,  6,  5,  6,  8,  10, 14, 18, 23, 29, 34,
    40, 45, 49, 53, 55, 57, 58, 57, 55, 53, 49, 45, 40, 34, 29, 23, 18, 14, 10, 7,  6,  5,  6,  7,
    10, 14, 18, 23, 29, 34, 40, 45, 49, 53, 56, 57, 58, 57, 56, 53, 49, 45, 40, 34, 29, 23, 18, 14,
    10, 7,  5,  5,  5,  7,  10, 14, 18, 23, 29, 34, 40, 45, 49, 53, 56, 58, 58, 58, 56, 53, 49, 45,
    40, 34, 29, 23, 18, 14, 10, 7,  5,  5,  5,  7,  10, 13, 18, 23, 29, 34, 40, 45, 50, 53, 56, 58,
    59, 58, 56, 53, 50, 45, 40, 34, 29, 23, 18, 13, 10, 7,  5,  4,  5,  7,  10, 13, 18, 23, 29, 34,
    40, 45, 50, 54, 56, 58, 59, 58, 56, 54, 50, 45, 40, 34, 29, 23, 18, 13, 9,  6,  5,  4,  5,  6,
    9,  13, 18, 23, 29, 34, 40, 45, 50, 54, 57, 58, 59, 58, 57, 54, 50, 45, 40, 34, 29, 23, 18, 13,
    9,  6,  4,  4,  4,  6,  9,  13, 18, 23, 29, 34, 40, 45, 50, 54, 57, 59, 59, 59, 57, 54, 50, 45,
    40, 34, 29, 23, 18, 13, 9,  6,  4,  4,  4,  6,  9,  13, 18, 23, 29, 34, 40, 46, 50, 54, 57, 59,
    60, 59, 57, 54, 50, 46, 40, 34, 29, 23, 17, 13, 9,  6,  4,  3,  4,  6,  9,  13, 17, 23, 29, 34,
    40, 46, 50, 54, 57, 59, 60, 59, 57, 54, 50, 46, 40, 34, 29, 23, 17, 13, 9,  6,  4,  3,  4,  6,
    9,  12, 17, 23, 29, 34, 40, 46, 51, 55, 58, 59, 60, 59, 58, 55, 51, 46, 40, 34, 29, 23, 17, 12,
    8,  5,  4,  3,  3,  5,  8,  12, 17, 23, 29, 34, 40, 46, 51, 55, 58, 60, 60, 60, 58, 55, 51, 46,
    40, 35, 28, 23, 17, 12, 8,  5,  3,  3,  3,  5,  8,  12, 17, 23, 28, 35, 40, 46, 51, 55, 58, 60,
    60, 60, 58, 55, 51, 46, 40, 35, 28, 23, 17, 12, 8,  5,  3,  2,  3,  5,  8,  12, 17, 23, 28, 35,
    40, 46, 51, 55, 58, 60, 61, 60, 58, 55, 51, 46, 41, 35, 28, 22, 17, 12, 8,  5,  3,  2,  3,  5,
    8,  12, 17, 22, 28, 35, 41, 46, 51, 55, 58, 60, 61, 60, 58, 55, 51, 46, 41, 35, 28, 22, 17, 12,
    8,  5,  3,  2,  3,  5,  8,  12, 17, 22, 28, 35, 41, 46, 51, 55, 58, 60, 61, 60, 59, 55, 51, 46,
    41, 35, 28, 22, 17, 12, 8,  4,  2,  2,  2,  4,  7,  12, 17, 22, 28, 35, 41, 46, 51, 56, 59, 61,
    61, 61, 59, 56, 51, 46, 41, 35, 28, 22, 17, 12, 7,  4,  2,  2,  2,  4,  7,  12, 17, 22, 28, 35,
    41, 46, 52, 56, 59, 61, 61, 61, 59, 56, 52, 46, 41, 35, 28, 22, 17, 11, 7,  4,  2,  1,  2,  4,
    7,  11, 16, 22, 28, 35, 41, 47, 52, 56, 59, 61, 62, 61, 59, 56, 52, 47, 41, 35, 28, 22, 16, 11,
    7,  4,  2,  1,  2,  4,  7,  11, 16, 22, 28, 35, 41, 47, 52, 56, 59, 61, 62, 61, 59, 56, 52, 47,
    41, 35, 28, 22, 16, 11, 7,  4,  2,  1,  2,  4,  7,  11, 16, 22, 28, 35, 41, 47, 52, 56, 59, 61,
    62, 61, 59, 56, 52, 47, 41, 35, 28, 22, 16, 11, 7,  4,  2,  1,  2,  4,  7,  11, 16, 22, 28, 35,
    41, 47, 52, 56, 59, 61, 62, 61, 59, 56, 52, 47, 41, 35, 28, 22, 16, 11, 7,  4,  2,  1,  2,  3,
    7,  11, 16, 22, 28, 35, 41, 47, 52, 56, 60, 62, 62, 62, 60, 56, 52, 47, 41, 35, 28, 22, 16, 11,
    7,  3,  1,  1,  1,  3,  7,  11, 16, 22, 28, 35, 41, 47, 52, 56, 60, 62, 62, 62, 60, 56, 52, 47,
    41, 35, 28, 22, 16, 11, 6,  3,  1,  1,  1,  3,  6,  11, 16, 22, 28, 35, 41, 47, 52, 57, 60, 62,
    62, 62, 60, 57, 52, 47, 41, 35, 28, 22, 16, 11, 6,  3,  1,  0,  1,  3,  6,  11, 16, 22, 28, 35,
    41, 47, 52, 57, 60, 62, 63, 62, 60, 57, 52, 47, 41, 35, 28, 22, 16, 11, 6,  3,  1,  0,  1,  3,
    6,  11, 16, 22, 28, 35, 41, 47, 52, 57, 60, 62, 63, 62, 60, 57, 52, 47, 41, 35, 28, 22, 16, 11,
    6,  3,  1,  0,  1,  3,  6,  11, 16, 22, 28, 35, 41, 47, 52, 57, 60, 62, 63, 62, 60, 57, 52, 47,
    41, 35, 28, 22, 16, 11, 6,  3,  1,  0,  1,  3,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 60, 62,
    63, 62, 60, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  3,  1,  0,  1,  3,  6,  10, 16, 22, 28, 35,
    41, 47, 53, 57, 60, 62, 63, 62, 60, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  3,  1,  0,  1,  3,
    6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 60, 62, 63, 62, 60, 57, 53, 47, 41, 35, 28, 22, 16, 10,
    6,  3,  1,  0,  1,  3,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 60, 62, 63, 62, 60, 57, 53, 47,
    41, 35, 28, 22, 16, 10, 6,  3,  0,  0,  0,  3,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 60, 63,
    63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35,
    41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,
    6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10,
    6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47,
    41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63,
    63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35,
    41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,
    6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10,
    6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47,
    41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63,
    63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35,
    41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,
    6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10,
    6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47,
    41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63,
    63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35,
    41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,
    6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47, 41, 35, 28, 22, 16, 10,
    6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63, 63, 63, 61, 57, 53, 47,
    41, 35, 28, 22, 16, 10, 6,  2,  0,  0,  0,  2,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 61, 63,
    63, 63, 60, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  3,  0,  0,  0,  3,  6,  10, 16, 22, 28, 35,
    41, 47, 53, 57, 60, 62, 63, 62, 60, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  3,  1,  0,  1,  3,
    6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 60, 62, 63, 62, 60, 57, 53, 47, 41, 35, 28, 22, 16, 10,
    6,  3,  1,  0,  1,  3,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 60, 62, 63, 62, 60, 57, 53, 47,
    41, 35, 28, 22, 16, 10, 6,  3,  1,  0,  1,  3,  6,  10, 16, 22, 28, 35, 41, 47, 53, 57, 60, 62,
    63, 62, 60, 57, 53, 47, 41, 35, 28, 22, 16, 10, 6,  3,  1,  0,  1,  3,  6,  11, 16, 22, 28, 35,
    41, 47, 52, 57, 60, 62, 63, 62, 60, 57, 52, 47, 41, 35, 28, 22, 16, 11, 6,  3,  1,  0,  1,  3,
    6,  11, 16, 22, 28, 35, 41, 47, 52, 57, 60, 62, 63, 62, 60, 57, 52, 47, 41, 35, 28, 22, 16, 11,
    6,  3,  1,  0,  1,  3,  6,  11, 16, 22, 28, 35, 41, 47, 52, 57, 60, 62, 63, 62, 60, 57, 52, 47,
    41, 35, 28, 22, 16, 11, 6,  3,  1,  0,  1,  3,  6,  11, 16, 22, 28, 35, 41, 47, 52, 57, 60, 62,
    62, 62, 60, 57, 52, 47, 41, 35, 28, 22, 16, 11, 6,  3,  1,  1,  1,  3,  6,  11, 16, 22, 28, 35,
    41, 47, 52, 56, 60, 62, 62, 62, 60, 56, 52, 47, 41, 35, 28, 22, 16, 11, 7,  3,  1,  1,  1,  3,
    7,  11, 16, 22, 28, 35, 41, 47, 52, 56, 60, 62, 62, 62, 60, 56, 52, 47, 41, 35, 28, 22, 16, 11,
    7,  3,  2,  1,  2,  4,  7,  11, 16, 22, 28, 35, 41, 47, 52, 56, 59, 61, 62, 61, 59, 56, 52, 47,
    41, 35, 28, 22, 16, 11, 7,  4,  2,  1,  2,  4,  7,  11, 16, 22, 28, 35, 41, 47, 52, 56, 59, 61,
    62, 61, 59, 56, 52, 47, 41, 35, 28, 22, 16, 11, 7,  4,  2,  1,  2,  4,  7,  11, 16, 22, 28, 35,
    41, 47, 52, 56, 59, 61, 62, 61, 59, 56, 52, 47, 41, 35, 28, 22, 16, 11, 7,  4,  2,  1,  2,  4,
    7,  11, 16, 22, 28, 35, 41, 47, 52, 56, 59, 61, 62, 61, 59, 56, 52, 47, 41, 35, 28, 22, 16, 11,
    7,  4,  2,  1,  2,  4,  7,  11, 17, 22, 28, 35, 41, 46, 52, 56, 59, 61, 61, 61, 59, 56, 52, 46,
    41, 35, 28, 22, 17, 12, 7,  4,  2,  2,  2,  4,  7,  12, 17, 22, 28, 35, 41, 46, 51, 56, 59, 61,
    61, 61, 59, 56, 51, 46, 41, 35, 28, 22, 17, 12, 7,  4,  2,  2,  2,  4,  8,  12, 17, 22, 28, 35,
    41, 46, 51, 55, 59, 60, 61, 60, 58, 55, 51, 46, 41, 35, 28, 22, 17, 12, 8,  5,  3,  2,  3,  5,
    8,  12, 17, 22, 28, 35, 41, 46, 51, 55, 58, 60, 61, 60, 58, 55, 51, 46, 41, 35, 28, 22, 17, 12,
    8,  5,  3,  2,  3,  5,  8,  12, 17, 22, 28, 35, 41, 46, 51, 55, 58, 60, 61, 60, 58, 55, 51, 46,
    40, 35, 28, 23, 17, 12, 8,  5,  3,  2,  3,  5,  8,  12, 17, 23, 28, 35, 40, 46, 51, 55, 58, 60,
    60, 60, 58, 55, 51, 46, 40, 35, 28, 23, 17, 12, 8,  5,  3,  3,  3,  5,  8,  12, 17, 23, 28, 35,
    40, 46, 51, 55, 58, 60, 60, 60, 58, 55, 51, 46, 40, 34, 29, 23, 17, 12, 8,  5,  3,  3,  4,  5,
    8,  12, 17, 23, 29, 34, 40, 46, 51, 55, 58, 59, 60, 59, 58, 55, 51, 46, 40, 34, 29, 23, 17, 12,
    9,  6,  4,  3,  4,  6,  9,  13, 17, 23, 29, 34, 40, 46, 50, 54, 57, 59, 60, 59, 57, 54, 50, 46,
    40, 34, 29, 23, 17, 13, 9,  6,  4,  3,  4,  6,  9,  13, 17, 23, 29, 34, 40, 46, 50, 54, 57, 59,
    60, 59, 57, 54, 50, 46, 40, 34, 29, 23, 18, 13, 9,  6,  4,  4,  4,  6,  9,  13, 18, 23, 29, 34,
    40, 45, 50, 54, 57, 59, 59, 59, 57, 54, 50, 45, 40, 34, 29, 23, 18, 13, 9,  6,  4,  4,  4,  6,
    9,  13, 18, 23, 29, 34, 40, 45, 50, 54, 57, 58, 59, 58, 57, 54, 50, 45, 40, 34, 29, 23, 18, 13,
    9,  6,  5,  4,  5,  6,  9,  13, 18, 23, 29, 34, 40, 45, 50, 54, 56, 58, 59, 58, 56, 54, 50, 45,
    40, 34, 29, 23, 18, 13, 10, 7,  5,  4,  5,  7,  10, 13, 18, 23, 29, 34, 40, 45, 50, 53, 56, 58,
    59, 58, 56, 53, 50, 45, 40, 34, 29, 23, 18, 13, 10, 7,  5,  5,  5,  7,  10, 14, 18, 23, 29, 34,
    40, 45, 49, 53, 56, 58, 58, 58, 56, 53, 49, 45, 40, 34, 29, 23, 18, 14, 10, 7,  5,  5,  5,  7,
    10, 14, 18, 23, 29, 34, 40, 45, 49, 53, 56, 57, 58, 57, 56, 53, 49, 45, 40, 34, 29, 23, 18, 14,
    10, 7,  6,  5,  6,  7,  10, 14, 18, 23, 29, 34, 40, 45, 49, 53, 55, 57, 58, 57, 55, 53, 49, 45,
    40, 34, 29, 23, 18, 14, 10, 8,  6,  5,  6,  8,  10, 14, 19, 23, 29, 34, 40, 44, 49, 52, 55, 57,
    57, 57, 55, 52, 49, 44, 39, 34, 29, 24, 19, 14, 11, 8,  6,  6,  6,  8,  11, 14, 19, 24, 29, 34,
    39, 44, 49, 52, 55, 57, 57, 57, 55, 52, 49, 44, 39, 34, 29, 24, 19, 14, 11, 8,  7,  6,  7,  8,
    11, 15, 19, 24, 29, 34, 39, 44, 48, 52, 55, 56, 57, 56, 55, 52, 48, 44, 39, 34, 29, 24, 19, 15,
    11, 9,  7,  6,  7,  9,  11, 15, 19, 24, 29, 34, 39, 44, 48, 52, 54, 56, 56, 56, 54, 52, 48, 44,
    39, 34, 29, 24, 19, 15, 11, 9,  7,  7,  7,  9,  11, 15, 19, 24, 29, 34, 39, 44, 48, 51, 54, 56,
    56, 56, 54, 51, 48, 44, 39, 34, 29, 24, 19, 15, 12, 9,  8,  7,  8,  9,  12, 15, 19, 24, 29, 34,
    39, 44, 48, 51, 54, 55, 56, 55, 54, 51, 48, 44, 39, 34, 29, 24, 19, 15, 12, 9,  8,  7,  8,  9,
    12, 15, 19, 24, 29, 34, 39, 44, 48, 51, 53, 55, 56, 55, 53, 51, 48, 43, 39, 34, 29, 24, 20, 16,
    12, 10, 8,  8,  8,  10, 12, 16, 20, 24, 29, 34, 39, 43, 47, 51, 53, 55, 55, 55, 53, 51, 47, 43,
    39, 34, 29, 24, 20, 16, 12, 10, 9,  8,  9,  10, 13, 16, 20, 24, 29, 34, 39, 43, 47, 50, 53, 54,
    55, 54, 53, 50, 47, 43, 39, 34, 29, 24, 20, 16, 13, 10, 9,  8,  9,  10, 13, 16, 20, 24, 29, 34,
    39, 43, 47, 50, 53, 54, 54, 54, 52, 50, 47, 43, 39, 34, 29, 24, 20, 16, 13, 11, 9,  9,  9,  11,
    13, 16, 20, 24, 29, 34, 39, 43, 47, 50, 52, 54, 54, 54, 52, 50, 47, 43, 38, 34, 29, 25, 20, 16,
    13, 11, 10, 9,  10, 11, 13, 17, 20, 25, 29, 34, 38, 43, 46, 50, 52, 53, 54, 53, 52, 49, 46, 43,
    38, 34, 29, 25, 20, 17, 14, 11, 10, 9,  10, 11, 14, 17, 20, 25, 29, 34, 38, 42, 46, 49, 52, 53,
    53, 53, 51, 49, 46, 42, 38, 34, 29, 25, 21, 17, 14, 12, 10, 10, 10, 12, 14, 17, 21, 25, 29, 34,
    38, 42, 46, 49, 51, 53, 53, 53, 51, 49, 46, 42, 38, 34, 29, 25, 21, 17, 14, 12, 11, 10, 11, 12,
    14, 17, 21, 25, 29, 34, 38, 42, 46, 49, 51, 52, 53, 52, 51, 49, 46, 42, 38, 34, 29, 25, 21, 17,
    15, 12, 11, 11, 11, 12, 15, 18, 21, 25, 29, 34, 38, 42, 45, 48, 51, 52, 52, 52, 50, 48, 45, 42,
    38, 34, 29, 25, 21, 18, 15, 13, 11, 11, 11, 13, 15, 18, 21, 25, 29, 34, 38, 42, 45, 48, 50, 51,
    52, 51, 50, 48, 45, 42, 38, 34, 29, 25, 21, 18, 15, 13, 12, 11, 12, 13, 15, 18, 21, 25, 29, 34,
    38, 42, 45, 48, 50, 51, 52, 51, 50, 48, 45, 41, 38, 34, 29, 25, 22, 18, 15, 13, 12, 12, 12, 13,
    16, 18, 22, 25, 29, 34, 38, 41, 45, 47, 49, 51, 51, 51, 49, 47, 45, 41, 38, 34, 29, 25, 22, 18,
    16, 14, 12, 12, 13, 14, 16, 19, 22, 26, 29, 34, 37, 41, 44, 47, 49, 50, 51, 50, 49, 47, 44, 41,
    37, 33, 30, 26, 22, 19, 16, 14, 13, 12, 13, 14, 16, 19, 22, 26, 30, 33, 37, 41, 44, 47, 49, 50,
    50, 50, 49, 47, 44, 41, 37, 33, 30, 26, 22, 19, 16, 14, 13, 13, 13, 15, 16, 19, 22, 26, 30, 33,
    37, 41, 44, 46, 48, 50, 50, 49, 48, 46, 44, 41, 37, 33, 30, 26, 22, 19, 17, 15, 14, 13, 14, 15,
    17, 19, 22, 26, 30, 33, 37, 41, 44, 46, 48, 49, 49, 49, 48, 46, 43, 40, 37, 33, 30, 26, 23, 20,
    17, 15, 14, 14, 14, 15, 17, 20, 23, 26, 30, 33, 37, 40, 43, 46, 48, 49, 49, 49, 48, 46, 43, 40,
    37, 33, 30, 26, 23, 20, 17, 16, 15, 14, 15, 16, 17, 20, 23, 26, 30, 33, 37, 40, 43, 45, 47, 48,
    49, 48, 47, 45, 43, 40, 37, 33, 30, 26, 23, 20, 18, 16, 15, 15, 15, 16, 18, 20, 23, 26, 30, 33,
    37, 40, 43, 45, 47, 48, 48, 48, 47, 45, 43, 40, 37, 33, 30, 26, 23, 20, 18, 16, 15, 15, 15, 16,
    18, 20, 23, 26, 30, 33, 37, 40, 42, 45, 46, 47, 48, 47, 46, 45, 42, 40, 37, 33, 30, 27, 23, 21,
    18, 17, 16, 15, 16, 17, 19, 21, 24, 27, 30, 33, 36, 39, 42, 44, 46, 47, 47, 47, 46, 44, 42, 39,
    36, 33, 30, 27, 24, 21, 19, 17, 16, 16, 16, 17, 19, 21, 24, 27, 30, 33, 36, 39, 42, 44, 46, 47,
    47, 47, 46, 44, 42, 39, 36, 33, 30, 27, 24, 21, 19, 18, 17, 16, 17, 18, 19, 21, 24, 27, 30, 33,
    36, 39, 42, 44, 45, 46, 46, 46, 45, 44, 41, 39, 36, 33, 30, 27, 24, 22, 20, 18, 17, 17, 17, 18,
    20, 22, 24, 27, 30, 33, 36, 39, 41, 43, 45, 46, 46, 46, 45, 43, 41, 39, 36, 33, 30, 27, 24, 22,
    20, 18, 17, 17, 18, 18, 20, 22, 24, 27, 30, 33, 36, 39, 41, 43, 44, 45, 46, 45, 44, 43, 41, 39,
    36, 33, 30, 27, 25, 22, 20, 19, 18, 18, 18, 19, 20, 22, 25, 27, 30, 33, 36, 38, 41, 43, 44, 45,
    45, 45, 44, 42, 41, 38, 36, 33, 30, 27, 25, 22, 21, 19, 18, 18, 18, 19, 21, 23, 25, 27, 30, 33,
    36, 38, 40, 42, 44, 44, 45, 44, 44, 42, 40, 38, 36, 33, 30, 27, 25, 23, 21, 20, 19, 19, 19, 20,
    21, 23, 25, 28, 30, 33, 35, 38, 40, 42, 43, 44, 44, 44, 43, 42, 40, 38, 35, 33, 30, 28, 25, 23,
    21, 20, 19, 19, 19, 20, 21, 23, 25, 28, 30, 33, 35, 38, 40, 41, 43, 43, 44, 43, 43, 41, 40, 38,
    35, 33, 30, 28, 25, 23, 22, 20, 20, 19, 20, 21, 22, 24, 26, 28, 30, 33, 35, 37, 39, 41, 42, 43,
    43, 43, 42, 41, 39, 37, 35, 33, 30, 28, 26, 24, 22, 21, 20, 20, 20, 21, 22, 24, 26, 28, 30, 33,
    35, 37, 39, 41, 42, 43, 43, 43, 42, 41, 39, 37, 35, 33, 30, 28, 26, 24, 23, 21, 21, 20, 21, 21,
    23, 24, 26, 28, 30, 33, 35, 37, 39, 40, 41, 42, 42, 42, 41, 40, 39, 37, 35, 33, 30, 28, 26, 24,
    23, 22, 21, 21, 21, 22, 23, 24, 26, 28, 30, 33, 35, 37, 38, 40, 41, 42, 42, 42, 41, 40, 38, 37,
    35, 33, 30, 28, 26, 25, 23, 22, 22, 21, 22, 22, 23, 25, 26, 28, 30, 33, 35, 36, 38, 40, 41, 41,
    41, 41, 41, 39, 38, 36, 35, 33, 30, 28, 27, 25, 24, 23, 22, 22, 22, 23, 24, 25, 27, 29, 31, 32,
    34, 36, 38, 39, 40, 41, 41, 41, 40, 39, 38, 36, 34, 32, 31, 29, 27, 25, 24, 23, 23, 22, 23, 23,
    24, 25, 27, 29, 31, 32, 34, 36, 38, 39, 40, 40, 40, 40, 40, 39, 37, 36, 34, 32, 31, 29, 27, 26,
    24, 24, 23, 23, 23, 24, 25, 26, 27, 29, 31, 32, 34, 36, 37, 38, 39, 40, 40, 40, 39, 38, 37, 36,
    34, 32, 31, 29, 27, 26, 25, 24, 23, 23, 23, 24, 25, 26, 27, 29, 31, 32, 34, 36, 37, 38, 39, 39,
    39, 39, 39, 38, 37, 35, 34, 32, 31, 29, 28, 26, 25, 24, 24, 24, 24, 24, 25, 26, 28, 29, 31, 32,
    34, 35, 37, 38, 38, 39, 39, 39, 38, 38, 36, 35, 34, 32, 31, 29, 28, 27, 26, 25, 24, 24, 24, 25,
    26, 27, 28, 29, 31, 32, 34, 35, 36, 37, 38, 38, 38, 38, 38, 37, 36, 35, 34, 32, 31, 29, 28, 27,
    26, 25, 25, 25, 25, 25, 26, 27, 28, 29, 31, 32, 34, 35, 36, 37, 37, 38, 38, 38, 37, 37, 36, 35,
    33, 32, 31, 30, 28, 27, 26, 26, 25, 25, 25, 26, 26, 27, 28, 30, 31, 32, 33, 35, 36, 36, 37, 37,
    37, 37, 37, 36, 35, 34, 33, 32, 31, 30, 29, 28, 27, 26, 26, 26, 26, 26, 27, 28, 29, 30, 31, 32,
    33, 34, 35, 36, 37, 37, 37, 37, 36, 36, 35, 34, 33, 32, 31, 30, 29, 28, 27, 27, 26, 26, 26, 27,
    27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 36, 36, 37, 36, 36, 36, 35, 34, 33, 32, 31, 30, 29, 28,
    28, 27, 27, 27, 27, 27, 28, 28, 29, 30, 31, 32, 33, 34, 35, 35, 36, 36, 36, 36, 36, 35, 34, 34,
    33, 32, 31, 30, 29, 29, 28, 28, 27, 27, 27, 28, 28, 29, 29, 30, 31, 32, 33, 34, 34, 35, 35, 35,
    36, 35, 35, 35, 34, 33, 33, 32, 31, 30, 30, 29, 28, 28, 28, 28, 28, 28, 28, 29, 30, 30, 31, 32,
    33, 33, 34, 34, 35, 35, 35, 35, 35, 34, 34, 33, 33, 32, 31, 30, 30, 29, 29, 28, 28, 28, 28, 29,
    29, 29, 30, 31, 31, 32, 32, 33, 34, 34, 34, 34, 35, 34, 34, 34, 33, 33, 32, 32, 31, 31, 30, 30,
    29, 29, 29, 29, 29, 29, 29, 30, 30, 31, 31, 32, 32, 33, 33, 34, 34, 34, 34, 34, 34, 33, 33, 33,
    32, 32, 31, 31, 30, 30, 30, 29, 29, 29, 29, 29, 30, 30, 30, 31, 31, 32, 32, 33, 33, 33, 33, 33,
    34, 33, 33, 33, 33, 32, 32, 32, 31, 31, 31, 30, 30, 30, 30, 30, 30, 30, 30, 30, 31, 31, 31, 32,
    32, 32, 33, 33, 33, 33, 33, 33, 33, 33, 32, 32, 32, 32, 31, 31, 31, 31, 30, 30, 30, 30, 30, 30,
    31, 31, 31, 31, 31, 32, 32, 32, 32, 32, 32, 32, 33, 32, 32, 32, 32, 32, 32, 32, 31, 31, 31, 31,
    31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
    32, 32, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 32, 32, 32, 32, 32, 32, 32,
    32,
};

const uint8_t sine_data[] ARCH_IMPL_PROG_MEM = {
    32, 32, 33, 34, 34, 35, 36, 36, 37, 37, 38, 39, 39, 40, 41, 41, 42, 43, 43, 44, 45, 45, 46, 46,
    47, 47, 48, 49, 49, 50, 50, 51, 51, 52, 52, 53, 53, 54, 54, 55, 55, 56, 56, 57, 57, 57, 58, 58,
    59, 59, 59, 60, 60, 60, 60, 61, 61, 61, 61, 62, 62, 62, 62, 62, 63, 63, 63, 63, 63, 63, 63, 63,
    63, 63, 63, 63, 63, 63, 63, 63, 63, 63, 63, 63, 63, 63, 63, 62, 62, 62, 62, 62, 61, 61, 61, 61,
    60, 60, 60, 60, 59, 59, 59, 58, 58, 57, 57, 57, 56, 56, 55, 55, 54, 54, 53, 53, 52, 52, 51, 51,
    50, 50, 49, 49, 48, 47, 47, 46, 46, 45, 45, 44, 43, 43, 42, 41, 41, 40, 39, 39, 38, 37, 37, 36,
    36, 35, 34, 34, 33, 32, 31, 31, 30, 29, 29, 28, 27, 27, 26, 26, 25, 24, 24, 23, 22, 22, 21, 20,
    20, 19, 18, 18, 17, 17, 16, 16, 15, 14, 14, 13, 13, 12, 12, 11, 11, 10, 10, 9,  9,  8,  8,  7,
    7,  6,  6,  6,  5,  5,  4,  4,  4,  3,  3,  3,  3,  2,  2,  2,  2,  1,  1,  1,  1,  1,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,
    1,  1,  2,  2,  2,  2,  3,  3,  3,  3,  4,  4,  4,  5,  5,  6,  6,  6,  7,  7,  8,  8,  9,  9,
    10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 16, 16, 17, 17, 18, 18, 19, 20, 20, 21, 22, 22, 23,
    24, 24, 25, 26, 26, 27, 27, 28, 29, 29, 30, 31, 31,
};

void usart_test()
{
    hal_usart_on (HAL_IMPL_USART_BAUD);
    char c = 'A';
    while (!mode_is_dirty()) {
        HAL_LOOP_DELAY (USART_TEST_DELAY_LOOP_COUNT);
        hal_usart_send_string (USART_TEST_STRING);
        hal_usart_send_char (c);

        if (++c > 'Z') {
            c = 'A';
        }
    }
    hal_usart_off();
}

static inline void dac_output_init()
{
    HAL_IO_MAKE_OUTPUT (ANALOG_OUTPUT_GPIO, ANALOG_OUTPUT_PIN_MASK);
}

static inline void dac_output_deinit()
{
    HAL_IO_OUT_LOW (ANALOG_OUTPUT_GPIO, ANALOG_OUTPUT_PIN_MASK);
}

static void runt_pulse_test_body (uint8_t highLevel, uint8_t lowLevel, uint16_t pulseWidth)
{
    HAL_IO_OUT_WRITE (RUNT_PULSE_TEST_OUTPUT_GPIO, highLevel);
    HAL_LOOP_DELAY (pulseWidth);
    HAL_IO_OUT_WRITE (RUNT_PULSE_TEST_OUTPUT_GPIO, lowLevel);
    HAL_LOOP_DELAY (pulseWidth);
}

void runt_pulse_test()
{
    dac_output_init();

    // Number of runt pulses per 1000 normal pulses
    uint32_t runtFreq        = RUNT_PULSE_FREQ;
    bool isPositiveRuntPulse = true; // true: Runt when going high, false: Runt when going low.

    while (!mode_is_dirty()) {
        uint8_t lowLevel    = RUNT_TEST_NORMAL_LOW_LEVEL;
        uint8_t highLevel   = RUNT_TEST_NORMAL_HIGH_LEVEL;
        uint16_t pulseWidth = RUNT_TEST_NORMAL_PULSE_WIDTH_LOOP_COUNT;

        if (--runtFreq == 0) {
            runtFreq   = RUNT_PULSE_FREQ;
            pulseWidth = RUNT_TEST_RUNT_PULSE_WIDTH_LOOP_COUNT;
            if (isPositiveRuntPulse) {
                highLevel = RUNT_TEST_RUNT_HIGH_LEVEL;
            } else {
                lowLevel = RUNT_TEST_RUNT_LOW_LEVEL;
            }
            isPositiveRuntPulse ^= 1;
        }

        runt_pulse_test_body (highLevel, lowLevel, pulseWidth);
    }

    dac_output_deinit();
}

static inline void two_pulses_test_init()
{
    HAL_IO_MAKE_OUTPUT (TWO_PULSES_TEST_OUTPUT_GPIO, TWO_PULSES_TEST_OUTPUT_PIN_MASK);
}

static inline void two_pulses_test_exit()
{
    HAL_IO_OUT_LOW (TWO_PULSES_TEST_OUTPUT_GPIO, TWO_PULSES_TEST_OUTPUT_PIN_MASK);
}

static void two_pulses_test_body (uint8_t pin_mask, uint16_t num_pulses, uint16_t pulse_width)
{
    while (num_pulses--) {
        HAL_IO_OUT_HIGH (TWO_PULSES_TEST_OUTPUT_GPIO, pin_mask);
        HAL_LOOP_DELAY (pulse_width);
        HAL_IO_OUT_LOW (TWO_PULSES_TEST_OUTPUT_GPIO, pin_mask);
        HAL_LOOP_DELAY (pulse_width);
    }
}

void two_pulses_test()
{
    two_pulses_test_init();

    while (!mode_is_dirty()) {
        two_pulses_test_body (TWO_PULSES_TEST_OUTPUT_PIN_NO0_MASK,
                              TWO_PULSES_TEST_NUMBER_OF_PULSES_PIN0, TWO_PULSES_TEST_PULSE_WIDTH);
        HAL_LOOP_DELAY (TWO_PULSES_TEST_DELAY_LOOP_COUNT);
        two_pulses_test_body (TWO_PULSES_TEST_OUTPUT_PIN_NO1_MASK,
                              TWO_PULSES_TEST_NUMBER_OF_PULSES_PIN1, TWO_PULSES_TEST_PULSE_WIDTH);
        HAL_LOOP_DELAY (TWO_PULSES_TEST_DELAY_LOOP_COUNT);
    }

    two_pulses_test_exit();
}

void sawtooth_test()
{
    uint16_t value = SAWTOOTH_TEST_LOW_LEVEL;
    dac_output_init();

    while (!mode_is_dirty()) {
        for (unsigned i = 0; i < DAC_WIDTH_MAX_VALUE; i++) {
            HAL_IO_OUT_WRITE (SAWTOOTH_TEST_OUTPUT_GPIO, value);
            value++;
        }
        value = SAWTOOTH_TEST_LOW_LEVEL;
    }
    dac_output_deinit();
}

void triangle_test()
{
    uint16_t value = TRIANGLE_TEST_LOW_LEVEL;

    dac_output_init();

    while (!mode_is_dirty()) {
        value = SAWTOOTH_TEST_LOW_LEVEL;
        for (unsigned i = 0; i < DAC_WIDTH_MAX_VALUE; i++) {
            HAL_IO_OUT_WRITE (TRIANGLE_TEST_OUTPUT_GPIO, value);
            value++;
        }
        value = SAWTOOTH_TEST_HIGH_LEVEL;
        for (unsigned i = 0; i < DAC_WIDTH_MAX_VALUE; i++) {
            HAL_IO_OUT_WRITE (TRIANGLE_TEST_OUTPUT_GPIO, value);
            value--;
#ifndef UNITTESTS
            // The below instructions is hacky way to make the number of instructions for the
            // falling egde same as the rising one above. Its hacky because it depends on the
            // compiler generated instructions.
            __asm__ volatile ("nop");
#endif // UNITTESTS
        }
    }
    dac_output_deinit();
}

static inline void i2c_test_init()
{
    HAL_IO_MAKE_OUTPUT (I2C_TEST_OUTPUT_GPIO, I2C_TEST_OUTPUT_PIN_MASK);

    // In idle state both SDL, SCL are high
    HAL_IO_OUT_HIGH (I2C_TEST_OUTPUT_GPIO, I2C_TEST_OUTPUT_PIN_MASK);
}

static inline void i2c_test_exit()
{
    // In idle state both SDL, SCL are high
    HAL_IO_OUT_HIGH (I2C_TEST_OUTPUT_GPIO, I2C_TEST_OUTPUT_PIN_MASK);
}

#define I2C_TEST_SDA_HIGH() HAL_IO_OUT_HIGH (I2C_TEST_OUTPUT_GPIO, I2C_TEST_OUTPUT_PIN_SDA_MASK);

#define I2C_TEST_SDA_LOW()  HAL_IO_OUT_LOW (I2C_TEST_OUTPUT_GPIO, I2C_TEST_OUTPUT_PIN_SDA_MASK);

#define I2C_TEST_SCL_HIGH()                                                   \
    do {                                                                      \
        HAL_LOOP_DELAY (I2C_TEST_SCL_HOLD_DELAY / 2);                         \
        HAL_IO_OUT_HIGH (I2C_TEST_OUTPUT_GPIO, I2C_TEST_OUTPUT_PIN_SCL_MASK); \
        HAL_LOOP_DELAY (I2C_TEST_SCL_HOLD_DELAY / 2);                         \
    } while (0)

#define I2C_TEST_SCL_LOW()                                                   \
    do {                                                                     \
        HAL_LOOP_DELAY (I2C_TEST_SCL_HOLD_DELAY / 2);                        \
        HAL_IO_OUT_LOW (I2C_TEST_OUTPUT_GPIO, I2C_TEST_OUTPUT_PIN_SCL_MASK); \
        HAL_LOOP_DELAY (I2C_TEST_SCL_HOLD_DELAY / 2);                        \
    } while (0)

static inline void i2c_start()
{
    // Start bit: SDA pulled low while SCL is high.
    I2C_TEST_SCL_HIGH();
    I2C_TEST_SDA_LOW();
}

static inline void i2c_stop()
{
    // In preparation to the stop bit, we pull the SDA line low with an extra clock pulse.
    I2C_TEST_SCL_LOW();
    I2C_TEST_SDA_LOW();

    // Stop bit: SDA pulled high while SCL is high.
    I2C_TEST_SCL_HIGH();
    I2C_TEST_SDA_HIGH();
}

static void i2c_send_byte (uint8_t b)
{
    for (unsigned i = 0; i < 8; i++, b = b << 1) {
        I2C_TEST_SCL_LOW();
        if (b & 0x80) {
            I2C_TEST_SDA_HIGH();
        } else {
            I2C_TEST_SDA_LOW();
        }
        I2C_TEST_SCL_HIGH();
    }

    // Send ACK
    // One extra clock pulse when SDA is low
    I2C_TEST_SCL_LOW();
    I2C_TEST_SDA_LOW();
    I2C_TEST_SCL_HIGH();
    HAL_LOOP_DELAY (20);
}

void i2c_test()
{
    i2c_test_init();
    while (!mode_is_dirty()) {
        // Start the packet
        i2c_start();

        // Send address, always is 0x5
        i2c_send_byte ((5 << 1) | 1); // Address = 5, R/W bit = 1

        // Send data as ASCII string
        for (char* c = I2C_TEST_STRING; *c != '\0'; c++) {
            i2c_send_byte (*c);
        }
        // Packet finished
        i2c_stop();

        // Some delay before next packet.
        HAL_LOOP_DELAY (40);
    }
    i2c_test_exit();
}

static void dump_into_dac_and_loop (const uint8_t data[], const size_t count)
{
    while (!mode_is_dirty()) {
        for (uint16_t i = 0; i < count; i++) {
#if !defined(UNITTESTS)
            HAL_IO_OUT_WRITE (ANALOG_OUTPUT_GPIO, pgm_read_byte (&data[i]));
#else
            HAL_IO_OUT_WRITE (ANALOG_OUTPUT_GPIO, data[i]);
#endif
        }
    }
}

void sine_test()
{
    dac_output_init();
    dump_into_dac_and_loop (sine_data, ARRAY_LEN (sine_data));
    dac_output_deinit();
}

void am_test()
{
    dac_output_init();
    dump_into_dac_and_loop (am_data, ARRAY_LEN (am_data));
    dac_output_deinit();
}
